# 📀 Redis 캐싱 전략

Redis는 인메모리 데이터 스토어로, 디스크 기반의 데이터베이스보다 빠른 응답이 가능하여 웹 서비스 환경에서 **시스템 성능 향상**을 기대할 수 있는 중요한 기술이다. 
하지만, 용량에 제한이 있어(16GB ~ 32GB) 모든 데이터를 저장하기에는 **용량 부족 현상**이 일어날 수 있다.

따라서 어떤 데이터를 저장할 것인지, 얼마나 데이터를 캐싱할 것인지, 어떤 데이터를 제거할 것인지에 대한 전략이 필요하다.
<br/>
<br/>
## 1. 캐싱 전략 패턴 종류
캐시를 이용하게 되면 반드시 닥쳐오는 문제점이 있는데 바로 **데이터 정합성 문제**이다.

데이터 정합성이란, 어느 한 데이터가 캐시(Cache Store)와 데이터베이스(Data Store) 이 두 곳에서 같은 데이터임에도 불구하고 데이터 정보값이 서로 다른 현상을 말한다.
캐시라는 또다른 데이터 저장소를 이용하기 때문에, 결국 같은 종류의 데이터라도 두 저장소에서 저장된 값이 서로 다를수 있는 현상이 일어날 수 밖에 없는 것이다.

따라서 적절한 캐시 읽기 전략(Read Cache Strategy)과 캐시 쓰기 전략(Write Cache Strategy)을 통해, 캐시와 DB간의 데이터 불일치 문제를 극복하면서도 빠른 성능을 잃지 않게 하기 위해 고심히 연구를 할 필요가 있다.

## 🔖 읽기 전략

### [1] Look-Aside
[1] Cache Store에 검색하는 데이터가 있는지 확인 후,<br/>
[2] 없을 경우 DB에서 데이터를 조회한다.<br/>
[3] DB에서 조회한 데이터를 Cache Store에 업데이트한다.<br/>
- 초기 조회 시 무조건 Data Store를 호출해야 하므로 단건 호출 빈도가 높은 서비스에 적합하지 않으며, 반복적으로 동일 쿼리를 수행하는 서비스에 적합한 아키텍처이다.
- 캐시와 DB가 분리되어 가용되기 때문에 원하는 데이터만 별도로 구성하여 캐시에 저장할 수 있고, 캐시 장애에 대한 대비를 할 수 있다.
  - 만일 redis가 다운 되더라도 DB에서 데이터를 가져올 수 있어 서비스 자체에는 지장이 없다.
  - 대신에 캐시에 붙어있던 connection이 많았다면, redis가 다운된 순간 순간적으로 DB로 몰려서 부하가 발생할 수 있다.
- Cache Store와 Data Store(DB)간 정합성 유지 문제가 발생할 수 있다.


### [2] Read-Through
[1] Cache Store에 검색하는 데이터가 있는지 확인 후,<br/>
[2] 없을 경우 DB에서 데이터를 조회하여 Cache Store에 자체 업데이트한다.<br/>
[3] Cache에서 데이터를 가져온다.<br/>
- 데이터를 조회하는데 있어 전체적으로 속도가 느리다.
  - Look Aside 와 비슷하지만 데이터 동기화를 라이브러리 또는 캐시 제공자에게 위임하는 방식이라는 점에서 차이가 있다.
- 직접적인 데이터베이스 접근을 최소화하고 Read 에 대한 소모되는 자원을 최소화할 수 있다.
- 데이터 조회를 전적으로 캐시에만 의지하므로, redis가 다운될 경우 서비스 이용에 차질이 생길 수 있다.
  - redis과 같은 구성 요소를 Replication 또는 Cluster로 구성하여 가용성을 높여야 한다. 
- 캐시와 DB간의 데이터 동기화가 항상 이루어져 데이터 정합성 문제에서 벗어날 수 있다.


## ✍️ 쓰기 전략

### [1] Write-Back
[1] 모든 데이터를 Cache Store에 저장하며,<br/>
[2] 일정 시간이 지난 후 Cache Store에 저장된 데이터를 일괄적으로 DB에 저장한다.<br/>

- 캐시와 DB 동기화 과정을 생략할 수 있다.
  - 데이터를 저장할 때 DB에 바로 쿼리하지 않고, 캐시에 모아서 일정 주기 배치 작업을 통해 DB에 반영한다.
  - 쓰기 쿼리 회수 비용과 부하를 줄일 수 있다.
- Write가 빈번하면서 Read를 하는데 많은 양의 Resource가 소모되는 서비스에 적합하다.
- 데이터 정합성이 확보된다.
- 자주 사용되지 않는 불필요한 리소스가 저장될 수 있다.
- 캐시에서 오류가 발생하면 데이터가 영구 소실된다.<br/>오히려 반대로 데이터베이스에 장애가 발생하더라도 지속적인 서비스를 제공할 수 있도록 보장하기도 한다.

### [2] Write-Through
[1] DB에 저장할 데이터가 있으면 우선 Cache Store에 저장하며,<br/>
[2] 바로 Cache Store에서 DB에 저장한다.<br/>

- 데이터베이스와 Cache에 동시에 데이터를 저장하는 전략이다.
- DB와 캐시가 항상 동기화 되어 있어, 캐시의 데이터를 항상 최신 상태로 유지할 수 있고 데이터 일관성을 유지할 수 있어서 안정적이다.
- 데이터 유실이 발생하면 안 되는 서비스에 적합하다.
- 자주 사용되지 않는 불필요한 리소스 저장될 수 있다.
- 매 요청마다 두번의 Write가 발생하게 됨으로써 빈번한 생성, 수정이 발생하는 서비스에서는 성능 이슈가 발생할 수 있다.
  - 기억장치 속도가 느릴 경우, 데이터를 기록할 때 CPU가 대기하는 시간이 필요하기 때문에 성능 감소

### [3] Write-Around
[1] 모든 데이터를 DB에만 저장한다.

- Cache miss가 발생하는 경우에만 DB와 캐시에도 데이터를 저장한다.
  - 캐시와 DB 내의 데이터가 다를 수 있다. (데이터 불일치)
  - 데이터베이스에 저장된 데이터가 수정, 삭제될 때마다, Cache 또한 삭제하거나 변경해야 하며, Cache의 expire를 짧게 조정하는 식으로 대처해야 한다.

<br/>

### [Reference]
- [[Redis] Redis 캐싱 전략 패턴 정리](https://minnseong.tistory.com/49)
- [[REDIS] 📚 캐시(Cache) 설계 전략 지침](https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC#read_through_+_write_through_%EC%A1%B0%ED%95%A9)